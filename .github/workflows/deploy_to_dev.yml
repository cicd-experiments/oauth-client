name: Deploy oauth-client to the development stand
on: workflow_dispatch
permissions: {}
jobs:
  checkstyle:
    environment: develop
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Make maven wrapper executable
        run: chmod +x mvnw
      - name: Cache maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: "${{ runner.os }}-m2-checksytle-${{ hashFiles('**/pom.xml') }}"
      - name: Run Checkstyle
        run: ./mvnw checkstyle:check
  test:
    environment: develop
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Run Keycloak container
        run: |
          docker run -d \
          --name testkeycloak \
          -p 8090:8080 -p 9000:9000 \
          -e KC_HTTP_PORT=8080 \
          -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
          -e KC_BOOTSTRAP_ADMIN_PASSWORD=pass \
          -e KC_HEALTH_ENABLED=true \
          -v /src/main/resources/keycloak:/opt/keycloak/data/import \
          keycloak/keycloak:26.1 \
          start-dev --import-realm
      - name: Healthcheck
        run: |
          curl --head -fsS http://testkeycloak:9000/health

#      - name: Inspect container
#        run: docker container inspect keycloak
#      - name: Import realm
#      - name: Set up JDK
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#      - name: Make maven wrapper executable
#        run: chmod +x mvnw
#      - name: Cache maven packages
#        uses: actions/cache@v3
#        with:
#          path: ~/.m2/repository
#          key: "${{ runner.os }}-m2-test-${{ hashFiles('**/pom.xml') }}"
#      - name: Setup Keycloak realm
#        run: |
#          docker exec -i keycloak bash "/opt/keycloak/bin/kc.sh show-config"
#        run: |
#          docker exec -it keycloak sh -c
#          "/opt/jboss/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin &&
#          /opt/jboss/keycloak/bin/kcadm.sh create realms -s realm=testrealm -s enabled=true &&
#          /opt/jboss/keycloak/bin/kcadm.sh create partialImport -r testrealm -s ifResourceExists=SKIP -o -f /src/main/resources/keycloak/realm.json"
#      - name: Run test
#        run: ./mvnw -B test --file pom.xml



#  build_and_push_iam-tool_image:
#    environment: develop
#    permissions:
#      contents: read
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#      - name: Login to Docker Hub
#        uses: docker/login-action@v3
#        with:
#          username: ${{ vars.DOCKERHUB_USERNAME }}
#          password: ${{ secrets.DOCKERHUB_TOKEN }}
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#      - name: Build and push image
#        uses: docker/build-push-action@v6
#        with:
#          context: .
#          push: true
#          tags: 'dipdeepcode/oauth-client:latest'
